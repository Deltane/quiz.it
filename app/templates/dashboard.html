<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quiz Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Header Navigation -->
  <header>
    <nav class="fixed-nav">
      <div class="nav-left">
        <span class="dashboard-title">Quiz Dashboard</span>
      </div>
      <div class="nav-right">
        {% if session.get('user_email') %}
          <a href="/" class="nav-button">Home</a>
          <a href="/create_quiz" class="nav-button">Create Quiz</a>
          <div class="user-info">
            <span>{{ session.get('user_name', session['user_email']) }}</span>
            <img src="{{ session['user_pic'] }}" alt="Profile" style="height: 30px; width: 30px; border-radius: 50%; object-fit: cover;">
            <a href="{{ url_for('auth.logout') }}" class="nav-button">Sign Out</a>
          </div>
        {% else %}
          <a href="{{ url_for('auth.login') }}" class="nav-button">Sign In with Google</a>
        {% endif %}
      </div>
    </nav>
  </header>

  <!-- Main Dashboard Content -->
  <main class="dashboard-container">
    <section class="stat-card">
      <h2>Total Quizzes Completed</h2>
      <p id="quizzes-completed">{{ stats.quizzes_completed }}</p>
    </section>

    <section class="stat-card">
      <h2>Quizzes with Scores Above 80%</h2>
      <p id="quizzes-above-80">{{ stats.quizzes_above_80 }}</p>
    </section>

    <section class="stat-card">
      <h2>Recent Quizzes</h2>
      <div id="recent-quizzes-list">
        {% for quiz in recent_quizzes %}
          <div class="quiz-entry">
            <span class="quiz-title">{{ quiz.title }}</span>
            <form action="/redo_quiz/{{ quiz.id }}" method="POST" style="display:inline;">
              <button class="action-button" type="submit">Redo</button>
            </form>
            <form action="/delete_quiz/{{ quiz.id }}" method="POST" style="display:inline;">
              <button class="action-button" type="submit">Delete</button>
            </form>
          </div>
        {% endfor %}
      </div>
    </section>

    <section class="stat-card">
      <h2>Most Frequent Quiz Type</h2>
      <p id="most-frequent-quiz-type">{{ stats.most_frequent_quiz_type }}</p>
    </section>

    <section class="chart-section">
      <h2>Quiz Performance</h2>
      <canvas id="quiz-performance-chart"></canvas>
    </section>

    <section class="stat-card">
      <h2>Filter and Sort</h2>
      <form id="filter-form">
        <label for="filter-type">Filter by:</label>
        <select id="filter-type" name="filter_type">
          <option value="all">All</option>
          <option value="quizzes_above_80">Above 80%</option>
          <option value="recent_quizzes">Recent Quizzes</option>
          <option value="most_frequent_quiz_type">Frequent Type</option>
        </select>

        <label for="sort-order">Sort:</label>
        <select id="sort-order" name="sort_order">
          <option value="desc">Descending</option>
          <option value="asc">Ascending</option>
        </select>

        <button type="submit">Apply</button>
      </form>
    </section>
    <section class="stat-card folder-panel">
      <h2>Your Folders</h2>

      <!-- Folder Creation Form -->
      <form action="/create_folder" method="POST" class="folder-form">
        <input type="text" name="folder_name" placeholder="New Folder Name" required>
        <button type="submit" class="action-button">Create</button>
      </form>

      <!-- Folder List -->
      <div class="folder-list">
        {% for folder in folders %}
          <div class="folder-entry">
            <strong>{{ folder.name }}</strong>
            <form action="/delete_folder/{{ folder.id }}" method="POST" style="display:inline;">
              <button class="action-button" type="submit">Delete</button>
            </form>

            <!-- Assign Quiz to This Folder -->
            <button type="button" onclick="toggleAssignForm({{ folder.id }})" class="action-button">Assign Quiz</button>
            <div id="assign-form-{{ folder.id }}" style="display: none; margin-top: 0.5rem;">
              <form action="/assign_quiz_to_folder" method="POST">
                <input type="hidden" name="folder_id" value="{{ folder.id }}">
                <select name="quiz_id" required>
                  <option value="">Select a Quiz</option>
                  {% for quiz in recent_quizzes if not quiz.folder_id %}
                    <option value="{{ quiz.id }}">{{ quiz.title }}</option>
                  {% endfor %}
                </select>
                <button class="action-button" type="submit">Add</button>
              </form>
            </div>

            <ul>
              {% for quiz in folder.quizzes %}
                <li>
                  {{ quiz.title }}
                  <form action="/redo_quiz/{{ quiz.id }}" method="POST" style="display:inline;">
                    <button class="action-button" type="submit">Redo</button>
                  </form>
                  <form action="/delete_quiz/{{ quiz.id }}" method="POST" style="display:inline;">
                    <button class="action-button" type="submit">Delete</button>
                  </form>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endfor %}
      </div>
    </section>
  </main>

  <!-- Chart & Filter Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const ctx = document.getElementById('quiz-performance-chart').getContext('2d');
      const quizPerformanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Total Quizzes', 'Above 80%'],
          datasets: [{
            label: 'Quiz Performance',
            data: [{{ stats.quizzes_completed }}, {{ stats.quizzes_above_80 }}],
            backgroundColor: ['rgba(75, 192, 192, 0.2)', 'rgba(255, 99, 132, 0.2)'],
            borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          animation: {
            duration: 1000,
            easing: 'easeInOutBounce'
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      document.getElementById('filter-form').addEventListener('submit', function (event) {
        event.preventDefault();
        const filterType = document.getElementById('filter-type').value;
        const sortOrder = document.getElementById('sort-order').value;

        fetch('/filter_stats', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ filter_type: filterType, sort_order: sortOrder })
        })
        .then(response => response.json())
        .then(data => {
          document.getElementById('quizzes-completed').textContent = data.quizzes_completed;
          document.getElementById('quizzes-above-80').textContent = data.quizzes_above_80;
          const recentQuizzesList = document.getElementById('recent-quizzes-list');
          recentQuizzesList.innerHTML = '';
          if (data.recent_quizzes && Array.isArray(data.recent_quizzes)) {
            data.recent_quizzes.forEach(quiz => {
              const entry = document.createElement('div');
              entry.classList.add('quiz-entry');
              entry.innerHTML = `
                <span class="quiz-title">${quiz.title}</span>
                <form action="/redo_quiz/${quiz.id}" method="POST" style="display:inline;">
                  <button class="action-button" type="submit">Redo</button>
                </form>
                <form action="/delete_quiz/${quiz.id}" method="POST" style="display:inline;">
                  <button class="action-button" type="submit">Delete</button>
                </form>
              `;
              recentQuizzesList.appendChild(entry);
            });
            // Attach confirmation to all new delete forms
            document.querySelectorAll('#recent-quizzes-list form[action^="/delete_quiz"]').forEach(form => {
              form.addEventListener('submit', function (e) {
                const confirmDelete = confirm('Are you sure you want to delete this quiz? This action cannot be undone.');
                if (!confirmDelete) e.preventDefault();
              });
            });
          }
          document.getElementById('most-frequent-quiz-type').textContent = data.most_frequent_quiz_type;
          quizPerformanceChart.data.datasets[0].data = [data.quizzes_completed, data.quizzes_above_80];
          quizPerformanceChart.update();

          // Attach confirmation to all existing delete forms (including initial HTML)
          document.querySelectorAll('form[action^="/delete_quiz"]').forEach(form => {
            form.addEventListener('submit', function (e) {
              const confirmDelete = confirm('Are you sure you want to delete this quiz? This action cannot be undone.');
              if (!confirmDelete) e.preventDefault();
            });
          });
        });
      });

      // Attach confirmation to all existing delete forms (including initial HTML)
      document.querySelectorAll('form[action^="/delete_quiz"]').forEach(form => {
        form.addEventListener('submit', function (e) {
          const confirmDelete = confirm('Are you sure you want to delete this quiz? This action cannot be undone.');
          if (!confirmDelete) e.preventDefault();
        });
      });
      // Also attach confirmation to folder quiz deletions
      document.querySelectorAll('.folder-entry form[action^="/delete_quiz"]').forEach(form => {
        form.addEventListener('submit', function (e) {
          const confirmDelete = confirm('Are you sure you want to delete this quiz? This action cannot be undone.');
          if (!confirmDelete) e.preventDefault();
        });
      });

      // Attach confirmation to all folder delete forms
      document.querySelectorAll('form[action^="/delete_folder"]').forEach(form => {
        form.addEventListener('submit', function (e) {
          const confirmDelete = confirm('Are you sure you want to delete this folder and unassign its quizzes?');
          if (!confirmDelete) e.preventDefault();
        });
      });
      // Assign quiz to folder with AJAX and inject HTML
      document.querySelectorAll('[id^="assign-form-"]').forEach(wrapper => {
        const form = wrapper.querySelector('form');
        if (form) {
          form.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(form);

            fetch('/assign_quiz_to_folder', {
              method: 'POST',
              body: formData
            })
            .then(res => res.json())
            .then(data => {
              if (data.quiz_html && data.folder_id) {
                const targetList = document.querySelector(`#assign-form-${data.folder_id}`).closest('.folder-entry').querySelector('ul');
                targetList.insertAdjacentHTML('beforeend', data.quiz_html);
                form.reset();
                wrapper.style.display = 'none';

                // Re-attach confirmation to new delete button in the inserted quiz
                const newQuizEntry = targetList.lastElementChild;
                const deleteForm = newQuizEntry.querySelector('form[action^="/delete_quiz"]');
                if (deleteForm) {
                  deleteForm.addEventListener('submit', function (e) {
                    const confirmDelete = confirm('Are you sure you want to delete this quiz? This action cannot be undone.');
                    if (!confirmDelete) e.preventDefault();
                  });
                }
              } else {
                alert("Failed to assign quiz to folder.");
              }
            });
          });
        }
      });
    });

    function toggleAssignForm(folderId) {
      const form = document.getElementById(`assign-form-${folderId}`);
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }
  </script>
</body>
</html>
